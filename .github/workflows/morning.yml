name: Morning TimeTree → LINE
on:
  schedule:
    # 毎朝 9:00 JST（= 0:00 UTC）
    - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      test_message:
        description: "任意のテスト文言（指定時はICSを無視して送信）"
        required: false
        type: string

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install -r requirements.txt

      - name: Export TimeTree to ICS
        env:
          TIMETREE_EMAIL: ${{ secrets.TIMETREE_EMAIL }}
          TIMETREE_PASSWORD: ${{ secrets.TIMETREE_PASSWORD }}
          TIMETREE_CAL_CODE: ${{ secrets.TIMETREE_CAL_CODE }} # 任意
        run: |
          mkdir -p data
          if [ -n "${TIMETREE_CAL_CODE}" ]; then
            timetree-exporter -o data/timetree.ics -e "${TIMETREE_EMAIL}" -c "${TIMETREE_CAL_CODE}" <<< "${TIMETREE_PASSWORD}"
          else
            timetree-exporter -o data/timetree.ics -e "${TIMETREE_EMAIL}" <<< "${TIMETREE_PASSWORD}"
          fi

      - name: Send LINE message
        env:
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_TO: ${{ secrets.LINE_TO }}
          USE_BROADCAST: ${{ secrets.USE_BROADCAST }}
          TEST_MESSAGE: ${{ github.event.inputs.test_message }}
        run: |
          if [ -n "${TEST_MESSAGE}" ]; then
            python scripts/notify_today.py --test "${TEST_MESSAGE}"
          else
            python scripts/notify_today.py
          fi
