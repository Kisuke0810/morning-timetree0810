name: Morning TimeTree → LINE
on:
  schedule:
    - cron: "0 1 * * *"     # JST 10:00（本命）
    - cron: "5 1 * * *"     # JST 10:05（バックアップ）
  workflow_dispatch:
    inputs:
      test_message:
        description: "任意のテスト文言（指定時はICSを無視して送信）"
        required: false
        type: string
      dump:
        description: "ダンプ表示（送信せずICSの解析結果を出力）"
        required: false
        type: boolean
      force:
        description: "再送を強制（キャッシュ送信済みでも送る）"
        required: false
        type: boolean
        default: false

concurrency:
  group: morning-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  notify:
    runs-on: [self-hosted]
    env:
      TZ: Asia/Tokyo
      FAIL_NOTIFY: ${{ secrets.FAIL_NOTIFY }}
      SENT_NAMESPACE: course
      ICS_PATH: data/timetree.ics
      SEND_EMPTY: 'true'
      CAL_LABEL: "講座"
    steps:
      - uses: actions/checkout@v4

      - name: Show clocks (UTC/JST)
        id: clocks
        run: |
          echo "UTC : $(date -u '+%Y-%m-%d %H:%M:%S %Z')"
          echo "JST : $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S %Z')"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install -r requirements.txt

      - name: Compute JST date
        id: jst
        run: echo "date=$(TZ=Asia/Tokyo date +%Y-%m-%d)" >> "$GITHUB_OUTPUT"

      - name: Restore sent cache
        id: cache
        uses: actions/cache@v4
        with:
          path: .sent-marker-${{ env.SENT_NAMESPACE }}
          key: sent-${{ env.SENT_NAMESPACE }}-${{ steps.jst.outputs.date }}

      - name: Export TimeTree to ICS
        id: export
        env:
          TIMETREE_EMAIL: ${{ secrets.TIMETREE_EMAIL }}
          TIMETREE_PASSWORD: ${{ secrets.TIMETREE_PASSWORD }}
          TIMETREE_CAL_CODE: ${{ secrets.TIMETREE_CAL_CODE }} # 任意
          FAIL_NOTIFY: ${{ secrets.FAIL_NOTIFY }}
        run: |
          mkdir -p data
          # JST 今日±30日をデフォルト期間として明示指定
          # today は TZ=Asia/Tokyo で解釈（ジョブenvでTZ指定済み）
          today=$(date +%Y-%m-%d)
          start=$(date -d "$today -30 days" +%Y-%m-%dT00:00:00+09:00)
          end=$(date -d "$today +31 days" +%Y-%m-%dT00:00:00+09:00)
          echo "Export window(JST): $start .. $end"

          CAL_OPT=""
          if [ -n "${TIMETREE_CAL_CODE}" ]; then
            CAL_OPT="-c \"${TIMETREE_CAL_CODE}\""
          fi

          # ヘルプから期間指定オプションを動的に検出
          HELP="$(timetree-exporter --help 2>/dev/null || true)"
          PERIOD_OPTS=""
          if echo "$HELP" | grep -q -- "--start" && echo "$HELP" | grep -q -- "--end"; then
            PERIOD_OPTS="--start \"$start\" --end \"$end\""
          elif echo "$HELP" | grep -q -- "--from" && echo "$HELP" | grep -q -- "--to"; then
            PERIOD_OPTS="--from \"$start\" --to \"$end\""
          elif echo "$HELP" | grep -q -- "--days-back" && echo "$HELP" | grep -q -- "--days-forward"; then
            PERIOD_OPTS="--days-back 30 --days-forward 30"
          else
            echo "[warn] timetree-exporter に期間指定オプションが見つかりませんでした。デフォルト範囲を使用します。"
          fi

          # シェルの引数展開のため eval を利用
          # shellcheck disable=SC2086
          eval timetree-exporter -o "${ICS_PATH}" -e "\"${TIMETREE_EMAIL}\"" $CAL_OPT $PERIOD_OPTS <<< "${TIMETREE_PASSWORD}"

      - name: Verify ICS generated
        run: |
          echo "ICS_PATH=${ICS_PATH}"
          ls -la data || true
          test -s "${ICS_PATH}" || (echo "::error::${ICS_PATH} not generated"; exit 1)

      - name: Debug ICS head
        run: |
          ls -l data || true
          head -n 40 "${ICS_PATH}" || true

      - name: Send LINE message
        id: send
        env:
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_TO: ${{ secrets.LINE_TO }}
          USE_BROADCAST: ${{ secrets.USE_BROADCAST }}
          SHOW_MEMO: ${{ secrets.SHOW_MEMO }}
          SHOW_LINKS: ${{ secrets.SHOW_LINKS }}
          MEMO_MAX: ${{ secrets.MEMO_MAX }}
          SLEEP_MS: ${{ secrets.SLEEP_MS }}
          TEST_MESSAGE: ${{ github.event.inputs.test_message }}
          DUMP: ${{ github.event.inputs.dump }}
          FAIL_NOTIFY: ${{ secrets.FAIL_NOTIFY }}
          JST_DATE: ${{ steps.jst.outputs.date }}
        if: ${{ steps.cache.outputs.cache-hit != 'true' || github.event.inputs.dump == 'true' || github.event.inputs.test_message != '' || github.event.inputs.force == 'true' }}
        run: |
          # If this is an actual scheduled send (not dump/test), wait until 10:00 JST strictly using JST epoch
          if [ "${DUMP}" != "true" ] && [ -z "${TEST_MESSAGE}" ]; then
            NOW_JST=$(TZ=Asia/Tokyo date +%s)
            TARGET_JST=$(TZ=Asia/Tokyo date -d "$(TZ=Asia/Tokyo date +%Y-%m-%d) 10:00" +%s)
            if [ "$NOW_JST" -lt "$TARGET_JST" ]; then
              echo "Sleep until JST 10:00..."; sleep $(( TARGET_JST - NOW_JST ));
            fi
          fi
          if [ "${DUMP}" = "true" ]; then
            echo "### TimeTree dump (先頭200行)" >> "$GITHUB_STEP_SUMMARY"
            python scripts/notify_today.py --dump | tee dump.csv
            head -n 200 dump.csv >> "$GITHUB_STEP_SUMMARY"
          elif [ -n "${TEST_MESSAGE}" ]; then
            python scripts/notify_today.py --test "${TEST_MESSAGE}"
          else
            python scripts/notify_today.py
            echo "sent=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Already sent today
        if: ${{ steps.cache.outputs.cache-hit == 'true' && github.event_name == 'schedule' && github.event.inputs.force != 'true' }}
        run: echo "本日は既に送信済み（${{ steps.jst.outputs.date }}）。スキップします。"

      - name: Upload ICS artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: timetree-ics-${{ github.run_id }}
          path: ${{ env.ICS_PATH }}
          if-no-files-found: warn

      - name: Write sent marker
        if: ${{ steps.send.outputs.sent == 'true' }}
        env:
          JST_DATE: ${{ steps.jst.outputs.date }}
        run: echo "sent on ${JST_DATE}" > ".sent-marker-${SENT_NAMESPACE}"

      - name: Save sent cache
        if: ${{ steps.send.outputs.sent == 'true' }}
        uses: actions/cache/save@v4
        with:
          path: .sent-marker-${{ env.SENT_NAMESPACE }}
          key: sent-${{ env.SENT_NAMESPACE }}-${{ steps.jst.outputs.date }}

      - name: Cron audit (list all crons)
        if: always()
        run: |
          echo "### Cron audit" >> "$GITHUB_STEP_SUMMARY"
          python tools/list_crons.py | tee cron_audit.txt
          echo >> "$GITHUB_STEP_SUMMARY"
          cat cron_audit.txt >> "$GITHUB_STEP_SUMMARY"

      - name: Failure alert (one-line)
        if: ${{ failure() && env.FAIL_NOTIFY == 'true' }}
        env:
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_TO: ${{ secrets.LINE_TO }}
          USE_BROADCAST: ${{ secrets.USE_BROADCAST }}
          FAIL_NOTIFY: ${{ secrets.FAIL_NOTIFY }}
          STEP_EXPORT: ${{ steps.export.outcome }}
          STEP_SEND: ${{ steps.send.outcome }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          step="unknown"
          if [ "${STEP_EXPORT}" = "failure" ]; then step="export"; fi
          if [ "${STEP_SEND}" = "failure" ]; then step="send"; fi
          ALERT_MESSAGE="⚠️ Morning TimeTree 配信失敗（step=${step}）
          ${RUN_URL}"
          export ALERT_MESSAGE
          python scripts/line_alert.py
